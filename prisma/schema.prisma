// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --------------------------------------
// Enums (고정된 상수값 정의)
// --------------------------------------

enum Role {
  NORMAL
  PRO
  ADMIN
}

enum ChallengeStatus {
  UNAPPROVED
  RECRUITING
  CLOSED
  COMPLETED
}

enum AdminStatus {
	PENDING
  APPROVED
  REJECTED
  DELETED
}

// --------------------------------------
// Models
// --------------------------------------

// 1. 유저 (User)
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  nickname  String
  password  String
  role      Role     @default(NORMAL)
  createdAt DateTime @default(now()) @map("created_at")

  // 관계 정의 (Relation Fields)
  createdChallenges Challenge[] @relation("UserCreatedChallenges")
  works             Work[]
  comments          Comment[]
  likes             Like[]

  @@map("users") // DB 테이블명: users
}

// 2. 챌린지 (Challenge)
model Challenge {
  id               Int             @id @default(autoincrement())
  creatorId        Int             @map("creator_id")
  title            String
  category         String
  documentType     String          @map("document_type")
  originalLink     String          @map("original_link")
  description      String          @db.Text // 긴 텍스트
  status           ChallengeStatus @default(UNAPPROVED) //승인된 챌린지 상태: 미승인, 모집중, 모집완료, 마감
  adminStatus      AdminStatus     @default(PENDING) //어드민이 부여: 대기, 승인, 거절, 삭제 
  adminDescription String          @db.Text // 긴 텍스트
  
  maxParticipants  Int             @default(0) @map("max_participants")
  
  createdAt        DateTime        @default(now()) @map("created_at")
  approvedAt       DateTime?       @map("approved_at")
  deadlineAt       DateTime?       @map("deadline_at")

  // 관계 정의
  creator User   @relation("UserCreatedChallenges", fields: [creatorId], references: [id], onDelete: Cascade)
  works   Work[]

  @@index([status]) // 상태값으로 자주 조회하므로 인덱스 추가
  @@map("challenges")
}

// 3. 작업물 (Work)
model Work {
  id          Int      @id @default(autoincrement())
  challengeId Int      @map("challenge_id")
  workerId    Int      @map("worker_id")
  isSelected  Boolean  @default(false) @map("is_selected")
  content     String   @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  // 관계 정의
  challenge Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  worker    User      @relation(fields: [workerId], references: [id], onDelete: Cascade)
  comments  Comment[]
  likes     Like[]

  @@index([challengeId])
  @@map("works")
}

// 4. 댓글 (Comment)
model Comment {
  id        Int      @id @default(autoincrement())
  workId    Int      @map("work_id")
  authorId  Int      @map("author_id")
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  // 관계 정의
  work   Work @relation(fields: [workId], references: [id], onDelete: Cascade)
  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@map("comments")
}

// 5. 좋아요/추천 (Like)
// N:M 관계의 중간 테이블 (Explicit Many-to-Many Relation)
model Like {
  workId    Int      @map("work_id")
  userId    Int      @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  // 관계 정의
  work Work @relation(fields: [workId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 복합 기본키 설정 (한 유저가 한 작업물에 중복 좋아요 방지)
  @@id([workId, userId])
  @@map("work_likes")
}